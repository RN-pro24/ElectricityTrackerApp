{% extends "layout.html" %}

{% block title %}
    Gadgets
{% endblock %}

{% block main %}

<h1>Gadgets</h1>

    <a href="/gadgets" class="btn btn-success btn-separator">View all Gadgets</a>

    <div class="button-group">
        <button id="boton_modificar_gadget" class="btn btn-secondary" style="margin-right: 10px;">Modify Gadget</button>
        <button id="boton_registrar_gadget" class="btn btn-primary">Register Gadget</button>
    </div>
    

    <!-- Tabla para mostrar los planes actuales -->
    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Gadget Name</th>
                <th>Watts</th>
                <th>Kwh</th>
                <th>Price Type</th>
                <th>Hours Usage</th>
                <th>Electrical efficiency</th>
                <th>Gadget Type</th>
                <th>House Location</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for gadget in gadgets %}
            <tr>
                <td>{{ gadget.date }}</td>
                <td>{{ gadget.gadget_name }}</td>
                <td>{{ gadget.watts }}</td>
                <td>{{ gadget.kWh }}</td>
                <td>{{ gadget.price_type }}</td>
                <td>{{ gadget.hours_usage }}</td>
                <td>{{ gadget.electrical_efficiency }}</td>
                <td>{{ gadget.gadget_type }}</td>
                <td>{{ gadget.house_location }}</td>
                <td>{{ gadget.status }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Modal para Seleccionar Plan -->
    <div id="modificar_gadget" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Select Gadget</h3>
            <form id="select_gadget" method="POST" action="/select_gadget">
                <div class="mb-3">
                    {% set errors = errors or {} %}
                    {% if errors.select_gadget %}
                    <p style="color: red;">{{errors.select_gadget}}</p>
                    {% endif %}
                    <label for="select_gadget">Choose a gadget:</label>
                    <select class="form-select mx-auto w-auto" id="select_gadget" name="select_gadget">
                        <option disabled selected>Gadget name</option>
                        {% for gadget in gadgets %}
        
                            <option value="{{ gadget['gadget_name'] }}">{{ gadget['gadget_name'] }}</option>
        
                        {% endfor %}
        
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Load</button>
            </form>
        </div>
    </div>

    {% if gadget %}
    <div id="modal_edit_gadget" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Edit Gadget</h3>
            <form id="edit_gadget" method="POST" action="/edit_gadget">
                <div class="mb-3">
                    {% if errors.date or errors.invalid_date %}
                        <p style="color: red;">{{ errors.date if errors.date else errors.invalid_date }}</p>
                    {% endif %}
                    <input id="date" name="date" required type="date" class="form-control" value="{{ gadget['date'] }}">
                </div>
                <div class="mb-3">
                    {% if errors.gadget_name or errors.gadget_name_not_exist %}
                        <p style="color: red;">{{errors.gadget_name if errors.gadget_name else errors.gadget_name_not_exist}}</p>
                    {% endif %}
                    <input id="gadget_name" name="gadget_name" required type="text" class="form-control" value="{{ gadget['gadget_name'] if gadget }}" readonly>
                
                </div>
                <div class="mb-3">
                    {% if errors.watts or errors.watts_not_exist %}
                        <p style="color: red;">{{errors.watts if errors.watts else errors.watts_not_exist}}</p>
                    {% endif %}
                    <input id="watts" name="watts" required type="number" class="form-control" value="{{ gadget['watts'] }}">
                </div>
                <div class="mb-3">
                    {% if errors.kWh or errors.kWh_not_exist %} 
                        <p style="color: red;">{{errors.kWh if errors.kWh else errors.kWh_not_exist}}</p>
                    {% endif %}
                    <input id="kWh" name="kWh" required type="number" maxlength="50" class="form-control" value="{{ gadget['kWh'] }}">
                </div>
                <div class="mb-3">
                    {% if errors.price_type or errors.price_type_not_exist %}
                        <p style="color: red;">{{ errors.price_type if errors.price_type else errors.price_type_not_exist }}</p>
                    {% endif %}
                    <label for="price_type">Select Price Type:</label>
                    <select id="price_type" name="price_type" class="form-control mx-auto w-auto">
                        <option disabled selected>Select an option</option>
                        {% for plan in plans %}
                            <option value="{{ plan['fee_name'] }}">{{ plan['fee_name'] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    {% if errors.hour_usage or errors.hour_usage_not_exist %}
                        <p style="color: red;">{{errors.hour_usage if errors.hour_usage else errors.hour_usage_not_exist}}</p>
                    {% endif %}
                    <input id="hours_usage" name="hours_usage" required type="number" class="form-control" value="{{ gadget['hours_usage'] }}">
                </div>
                <div class="mb-3">
                    {% if errors.electrical_efficiency or errors.electrical_efficiency_not_valid %}
                        <p style="color: red;">{{errors.electrical_efficiency if errors.electrical_efficiency else errors.electrical_efficiency}}</p>
                    {% endif %}
                    <input id="electrical_efficiency" name="electrical_efficiency" required type="text" class="form-control" value="{{ gadget['electrical_efficiency'] }}" oninput="capitalizeFirstLetter(this)" maxlength="5" class="form-control">
                </div>
                <div class="mb-3">
                    {% if errors.gadget_type  or errors.gadget_type_not_valid %}
                        <p style="color: red;">{{errors.gadget_type if errors.gadget_type else errors.gadget_type_not_valid}}</p>
                    {% endif %}
                    <input id="gadget_type" name="gadget_type" required type="text" class="form-control" value="{{ gadget['gadget_type'] }}" oninput="capitalizeFirstLetter(this)" maxlength="20" class="form-control">
                </div>
                <div class="mb-3">
                    {% if errors.house_location  or errors.house_location_not_valid %}
                        <p style="color: red;">{{errors.house_location if errors.house_location else errors.house_location_not_valid}}</p>
                    {% endif %}
                    <input id="house_location" name="house_location" required type="text" class="form-control" value="{{ gadget['house_location'] }}" oninput="capitalizeFirstLetter(this)" maxlength="20" class="form-control">
                </div>
                <div class="mb-3">
                    {% if errors.status  or errors.status_not_valid %}
                        <p style="color: red;">{{errors.status if errors.status else errors.status_not_valid}}</p>
                    {% endif %}
                    <input id="status" name="status" required type="text" class="form-control" value="{{ gadget['status'] }}" oninput="capitalizeFirstLetter(this)" maxlength="20" >
                </div>
                <button class="btn btn-primary" type="submit">Update Data</button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Modal para Registrar Nuevo Plan -->
    <div id="registrar_gadget" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Register New Gadget</h3>
            <form id="register_gadget" action="/register_gadget" method="post">
                <div class="mb-3">
                    {% if errors.date or errors.invalid_date %}
                        <p style="color: red;">{{ errors.date if errors.date else errors.invalid_date }}</p>
                    {% endif %}
                    <input autocomplete="off" class="form-control mx-auto w-auto" id="date" name="date" required type="date">
                </div>
                <div class="mb-3">
                    {% if errors.gadget_name or errors.gadget_name_not_exist %}
                        <p style="color: red;">{{errors.gadget_name if errors.gadget_name else errors.gadget_name_not_exist}}</p>
                    {% endif %}
                    <input autocomplete="off" autofocus class="form-control mx-auto w-auto" id="gadget_name" name="gadget_name" required placeholder="Gadget Name" type="text" oninput="capitalizeFirstLetter(this)" maxlength="14">
                <p>Ensure the device name is correct, as you won't be able to modify it after registration.</p>
                </div>
                <div class="mb-3">
                    {% if errors.watts or errors.watts_not_exist %}
                        <p style="color: red;">{{errors.watts if errors.watts else errors.watts_not_exist}}</p>
                    {% endif %}
                    <input autocomplete="off" autofocus class="form-control mx-auto w-auto" id="watts" name="watts" required placeholder="Watts" type="number" min="0" step="0.01">
                </div>
                <div class="mb-3">
                    {% if errors.kWh or errors.kWh_not_exist %}
                        <p style="color: red;">{{errors.kWh if errors.kWh else errors.kWh_not_exist}}</p>
                    {% endif %}
                    <input id="kWh" autocomplete="off" name="kWh" autofocus required type="number" maxlength="50" placeholder="Kwh" class="form-control mx-auto w-auto" min="0" step="0.01">
                </div>
                <div class="mb-3">
                    {% if errors.price_type or errors.price_type_not_exist %}
                        <p style="color: red;">{{ errors.price_type if errors.price_type else errors.price_type_not_exist }}</p>
                    {% endif %}
                    <label for="price_type">Select Price Type:</label>
                    <select id="price_type" name="price_type" class="form-control mx-auto w-auto">
                        <option disabled selected>Select an option</option>
                        {% for plan in plans %}
                            <option value="{{ plan['fee_name'] }}">{{ plan['fee_name'] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    {% if errors.hour_usage or errors.hour_usage_not_exist %}
                        <p style="color: red;">{{errors.hour_usage if errors.hour_usage else errors.hour_usage_not_exist}}</p>
                    {% endif %}
                    <input id="hours_usage" name="hours_usage" required type="number" placeholder="Hour Usage" class="form-control mx-auto w-auto">
                </div>
                <div class="mb-3">
                    {% if errors.electrical_efficiency or errors.electrical_efficiency_not_valid %}
                        <p style="color: red;">{{errors.electrical_efficiency if errors.electrical_efficiency else errors.electrical_efficiency}}</p>
                    {% endif %}
                    <input id="electrical_efficiency" name="electrical_efficiency" placeholder="Electrical Efficiency" required type="text" class="form-control mx-auto w-auto" oninput="capitalizeFirstLetter(this)" maxlength="5" >
                </div>
                <div class="mb-3">
                    {% if errors.gadget_type  or errors.gadget_type_not_valid %}
                        <p style="color: red;">{{errors.gadget_type if errors.gadget_type else errors.gadget_type_not_valid}}</p>
                    {% endif %}
                    <input id="gadget_type" name="gadget_type" placeholder="Gadget Type"required type="text" class="form-control mx-auto w-auto" oninput="capitalizeFirstLetter(this)" maxlength="20" >
                </div>
                <div class="mb-3">
                    {% if errors.house_location  or errors.house_location_not_valid %}
                        <p style="color: red;">{{errors.house_location if errors.house_location else errors.house_location_not_valid}}</p>
                    {% endif %}
                    <input id="house_location" name="house_location" placeholder="House Location" required type="text" class="form-control mx-auto w-auto"  oninput="capitalizeFirstLetter(this)" maxlength="20" >
                </div>
                <div class="mb-3">
                    {% if errors.status  or errors.status_not_valid %}
                        <p style="color: red;">{{errors.status if errors.status else errors.status_not_valid}}</p>
                    {% endif %}
                    <input id="status" name="status" placeholder="Status" required type="text" class="form-control mx-auto w-auto" oninput="capitalizeFirstLetter(this)" maxlength="20" >
                </div>
                <button class="btn btn-primary" type="submit">Register</button>
            </form>
        </div>
    </div>

    <script src="scripts.js"></script>
    <script>

        document.addEventListener("DOMContentLoaded", () => {
    const modalToOpen = "{{ modal_to_open }}";

    const modals = {
        edit: document.getElementById("modal_edit_gadget"),
        register: document.getElementById("registrar_gadget")
    };

    if (modals[modalToOpen]) {
        modals[modalToOpen].style.display = "block";
    }

    // Obtener botones y modales
    const modificar_gadget = document.getElementById("modificar_gadget");
    const registrar_gadget = document.getElementById("registrar_gadget");

    const btnModificar = document.getElementById("boton_modificar_gadget");
    const btnRegistrar = document.getElementById("boton_registrar_gadget");

    // Abrir modales
    btnModificar.addEventListener("click", () => modificar_gadget.style.display = "block");
    btnRegistrar.addEventListener("click", () => registrar_gadget.style.display = "block");

    // Cerrar modales con botón
    document.querySelectorAll(".close").forEach(closeBtn => {
        closeBtn.addEventListener("click", () => {
            const modal = closeBtn.closest(".modal");
            if (modal) modal.style.display = "none";
        });
    });

    // Cerrar modal haciendo clic fuera
    window.addEventListener("click", event => {
        if (event.target === modificar_gadget) modificar_gadget.style.display = "none";
        if (event.target === registrar_gadget) registrar_gadget.style.display = "none";
    });
});

    document.addEventListener("DOMContentLoaded", function() {
        var modalToOpen = "{{ modal_to_open }}";
        if (modalToOpen === "modal_edit_gadget") {
            document.getElementById("modal_edit_gadget").style.display = "block";
        }
        });

        document.addEventListener("DOMContentLoaded", () => {
            if (modalToOpen === "edit") {
                document.getElementById("modal_edit_gadget").style.display = "block";
            } else if (modalToOpen === "register") {
                document.getElementById("modalRegistrar").style.display = "block";
            }
         });
    </script>

{% endblock %}

